<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment - LearnHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/theme.css" />
</head>
<body class="antialiased text-gray-900 bg-gray-50">
  <header class="header-sticky bg-white">
    <nav class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="/landing.html" class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
          LearnTrack
        </a>
        <a href="/studentDashboard.html" class="text-gray-700 hover:text-indigo-600 font-medium">Back to Dashboard</a>
      </div>
    </nav>
  </header>

  <main class="max-w-4xl mx-auto p-6">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Course Details -->
      <section class="bg-white rounded-2xl shadow-lg p-6 border">
        <h2 class="text-2xl font-bold mb-4">Course Details</h2>
        <div id="course-details">
          <div class="animate-pulse">
            <div class="h-40 bg-gray-200 rounded-lg mb-4"></div>
            <div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
      </section>

      <!-- Payment Form -->
      <section class="bg-white rounded-2xl shadow-lg p-6 border">
        <h2 class="text-2xl font-bold mb-4">Payment Information</h2>
        
        <div class="mb-6">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-900">
              <strong>Demo Mode:</strong> This is a simplified payment flow. In production, you would integrate with Stripe, PayPal, or another payment gateway.
            </p>
          </div>
        </div>

        <form id="payment-form" class="space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Card Number</label>
            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">Expiry Date</label>
              <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">CVV</label>
              <input type="text" id="cvv" placeholder="123" maxlength="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">Cardholder Name</label>
            <input type="text" id="cardholder" placeholder="John Doe" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
          </div>

          <div class="border-t pt-4 mt-6">
            <div class="flex justify-between items-center mb-4">
              <span class="text-lg font-semibold">Total Amount:</span>
              <span id="total-amount" class="text-2xl font-bold text-indigo-600">R0.00</span>
            </div>
          </div>

          <button type="submit" id="pay-btn" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg transition-all">
            Complete Payment
          </button>

          <p class="text-xs text-gray-500 text-center">
            By completing this purchase, you agree to our Terms of Service
          </p>
        </form>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabaseClient.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let courseId = null;
    let courseData = null;

    // Get course ID from URL
    const params = new URLSearchParams(window.location.search);
    courseId = params.get('courseId');

    if (!courseId) {
      alert('No course selected');
      window.location.href = '/studentDashboard.html';
    }

    // Load course details
    async function loadCourse() {
      try {
        const token = sessionStorage.getItem('token');
        if (!token) {
          window.location.href = '/signIn.html';
          return;
        }

        const response = await fetch(`/api/courses/${courseId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load course');

        const { data: course } = await response.json();
        courseData = course;

        // Display course details
        const price = (course.price_cents / 100).toFixed(2);
        document.getElementById('total-amount').textContent = `R${price}`;

        document.getElementById('course-details').innerHTML = `
          <div class="h-40 bg-gradient-to-br from-indigo-400 to-purple-600 rounded-lg mb-4 flex items-center justify-center text-white text-3xl font-bold">
            ${course.title.substring(0, 2).toUpperCase()}
          </div>
          <h3 class="text-xl font-bold mb-2">${course.title}</h3>
          <p class="text-gray-600 text-sm mb-3">${course.description || 'No description'}</p>
          <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
            <span>ðŸ“š ${course.category}</span>
            <span>ðŸ“Š ${course.level}</span>
          </div>
          <div class="border-t pt-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Course Price:</span>
              <span class="text-2xl font-bold text-indigo-600">R${price}</span>
            </div>
          </div>
        `;

      } catch (err) {
        console.error('Failed to load course:', err);
        alert('Failed to load course details');
        window.location.href = '/studentDashboard.html';
      }
    }

    // Format card number with spaces
    document.getElementById('card-number').addEventListener('input', (e) => {
      let value = e.target.value.replace(/\s/g, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });

    // Format expiry date
    document.getElementById('expiry').addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
      }
      e.target.value = value;
    });

    // Only allow numbers in CVV
    document.getElementById('cvv').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    // Handle payment
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('pay-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const token = sessionStorage.getItem('token');

        // Simulate payment processing (in production, this would go to Stripe/PayPal)
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Process enrollment after successful payment
        const enrollResponse = await fetch('/api/enrollments/enroll', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            course_id: courseId,
            purchased: true
          })
        });

        if (!enrollResponse.ok) {
          const error = await enrollResponse.json();
          throw new Error(error.error || 'Enrollment failed');
        }

        // Redirect to course view
        alert('âœ“ Payment successful! You are now enrolled in the course.');
        window.location.href = `/courseView.html?id=${courseId}`;

      } catch (err) {
        console.error('Payment error:', err);
        alert('Payment failed: ' + err.message);
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    // Load course on page load
    document.addEventListener('DOMContentLoaded', loadCourse);
  </script>
</body>
</html>
