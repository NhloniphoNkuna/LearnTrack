<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Course - LearnTrack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/theme.css" />
  <script src="/js/notifications.js"></script>
</head>
<body class="antialiased text-gray-900 bg-gray-50">
  <header class="header-sticky bg-white" id="header">
    <nav class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="/landing.html" class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">LearnTrack</a>
        <div class="hidden md:flex items-center gap-6">
          <a href="/instructorDashboard.html" class="nav-link text-gray-700 hover:text-indigo-600 font-medium">Dashboard</a>
          <a href="/courseCreate.html" class="nav-link text-gray-700 hover:text-indigo-600 font-medium">Create Course</a>
          <a href="/instructorProfile.html" class="nav-link text-gray-700 hover:text-indigo-600 font-medium">Profile</a>
          <button id="signout" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors">Sign Out</button>
        </div>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Course Header -->
    <section class="bg-white rounded-2xl shadow-lg p-6 border">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 id="course-title" class="text-2xl font-bold mb-2">Loading...</h1>
          <p id="course-meta" class="text-gray-600"></p>
        </div>
        <div class="flex gap-3">
          <a href="/instructorDashboard.html" class="px-4 py-2 border rounded-lg font-semibold hover:bg-gray-50">Back to Dashboard</a>
          <button id="delete-course-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">Delete Course</button>
        </div>
      </div>
      <div id="course-stats" class="grid grid-cols-4 gap-4 mt-4">
        <div class="p-3 bg-indigo-50 rounded-lg">
          <p class="text-sm text-indigo-900">Sections</p>
          <p id="stat-sections" class="text-2xl font-bold text-indigo-700">0</p>
        </div>
        <div class="p-3 bg-purple-50 rounded-lg">
          <p class="text-sm text-purple-900">Videos</p>
          <p id="stat-videos" class="text-2xl font-bold text-purple-700">0</p>
        </div>
        <div class="p-3 bg-pink-50 rounded-lg">
          <p class="text-sm text-pink-900">Documents</p>
          <p id="stat-docs" class="text-2xl font-bold text-pink-700">0</p>
        </div>
        <div class="p-3 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-900">Links</p>
          <p id="stat-links" class="text-2xl font-bold text-blue-700">0</p>
        </div>
      </div>
    </section>

    <!-- Course Sections -->
    <section class="bg-white rounded-2xl shadow-lg p-6 border">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Course Sections</h2>
        <button id="add-section-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">+ Add Section</button>
      </div>
      
      <div id="sections-container" class="space-y-4">
        <div class="text-center py-8 text-gray-500">No sections yet. Click "Add Section" to start.</div>
      </div>
    </section>
  </main>

  <!-- Add Section Modal -->
  <div id="section-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">Add Section</h3>
      <input type="text" id="section-title-input" placeholder="Section Title" class="w-full px-4 py-2 border rounded-lg mb-4" />
      <div class="flex justify-end gap-3">
        <button id="cancel-section-btn" class="px-4 py-2 border rounded-lg">Cancel</button>
        <button id="save-section-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">Add Section</button>
      </div>
    </div>
  </div>

  <!-- Add Content Modal -->
  <div id="content-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">Add Content to <span id="modal-section-title"></span></h3>
      
      <div class="space-y-4">
        <!-- Upload Video -->
        <div class="border rounded-lg p-4">
          <h4 class="font-semibold mb-2">ðŸ“¹ Upload Video</h4>
          <input type="file" id="video-upload" accept="video/*" class="hidden" />
          <button id="video-upload-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg w-full">Choose Video File</button>
          <div id="video-upload-progress" class="hidden mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="video-progress-bar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p id="video-progress-text" class="text-sm text-gray-600 mt-1">Uploading...</p>
          </div>
        </div>

        <!-- Upload Document -->
        <div class="border rounded-lg p-4">
          <h4 class="font-semibold mb-2">ðŸ“„ Upload Document</h4>
          <input type="file" id="doc-upload" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.xlsx" class="hidden" />
          <button id="doc-upload-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg w-full">Choose Document File</button>
          <div id="doc-upload-progress" class="hidden mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="doc-progress-bar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p id="doc-progress-text" class="text-sm text-gray-600 mt-1">Uploading...</p>
          </div>
        </div>

        <!-- Add Link -->
        <div class="border rounded-lg p-4">
          <h4 class="font-semibold mb-2">ðŸ”— Add External Link</h4>
          <input type="text" id="link-title-input" placeholder="Link Title" class="w-full px-4 py-2 border rounded-lg mb-2" />
          <input type="url" id="link-url-input" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg mb-2" />
          <button id="add-link-btn-modal" class="px-4 py-2 bg-indigo-600 text-white rounded-lg w-full">Add Link</button>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button id="close-content-modal-btn" class="px-4 py-2 border rounded-lg">Close</button>
      </div>
    </div>
  </div>

  <!-- Content Viewer Modal -->
  <div id="viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 id="viewer-title" class="text-xl font-bold"></h3>
        <button id="close-viewer-btn" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Close</button>
      </div>
      
      <div id="viewer-content" class="mt-4">
        <!-- Content will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <script>
    let courseId = null;
    let currentSectionId = null;
    let sections = [];

    document.getElementById('signout')?.addEventListener('click', async () => {
      try {
        // Clear session storage
        sessionStorage.clear();
        
        // Sign out from Supabase if available
        if (window.supabase) {
          await window.supabase.auth.signOut();
        }
        
        // Redirect to landing page
        window.location.href = '/landing.html';
      } catch (err) {
        console.error('Sign out error:', err);
        // Clear storage anyway and redirect
        sessionStorage.clear();
        window.location.href = '/landing.html';
      }
    });

    // Get course ID from URL
    const params = new URLSearchParams(window.location.search);
    courseId = params.get('id');

    if (!courseId) {
      window.Notifications.error('No course ID provided');
      setTimeout(() => {
        window.location.href = '/instructorDashboard.html';
      }, 1000);
    } else {
      // Load course if ID exists
      loadCourse();
    }

    // Load course details
    async function loadCourse() {
      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/api/courses/${courseId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load course');

        const { data: course } = await response.json();
        document.getElementById('course-title').textContent = course.title;
        document.getElementById('course-meta').textContent = `${course.category} â€¢ ${course.level} â€¢ ${course.price_cents > 0 ? 'R' + (course.price_cents/100).toFixed(2) : 'Free'}`;

        await loadSections();
      } catch (err) {
        console.error('Failed to load course:', err);
        window.Notifications.error('Failed to load course');
      }
    }

    // Load course sections
    async function loadSections() {
      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/api/courses/${courseId}/outline`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load sections');

        const { data: sectionData } = await response.json();
        sections = sectionData || [];
        renderSections();
        updateStats();
      } catch (err) {
        console.error('Failed to load sections:', err);
      }
    }

    // Render sections
    function renderSections() {
      const container = document.getElementById('sections-container');
      
      if (sections.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No sections yet. Click "Add Section" to start.</div>';
        return;
      }

      container.innerHTML = sections.map((section, idx) => `
        <div class="border rounded-lg p-4 bg-gray-50">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-lg">${idx + 1}. ${section.title}</h3>
            <div class="flex gap-2">
              <button onclick="openContentModal('${section.id}', '${section.title}')" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">+ Add Content</button>
              <button onclick="deleteSection('${section.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Delete</button>
            </div>
          </div>
          
          <div class="space-y-2">
            ${section.lessons && section.lessons.length > 0 ? section.lessons.map(lesson => `
              <div class="flex items-center justify-between bg-white p-3 rounded border hover:shadow-sm transition">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">${lesson.video_url ? 'ðŸ“¹' : lesson.resource_urls && lesson.resource_urls.length > 0 ? 'ðŸ“„' : 'ðŸ”—'}</span>
                  <div>
                    <p class="font-medium">${lesson.title}</p>
                    ${lesson.video_url ? '<p class="text-xs text-gray-500">Video</p>' : 
                      lesson.resource_urls && lesson.resource_urls.length > 0 ? '<p class="text-xs text-gray-500">Document/Link</p>' : 
                      '<p class="text-xs text-gray-500">Link</p>'}
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick='viewContent(${JSON.stringify(lesson)})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">View</button>
                  <button onclick="deleteLesson('${section.id}', '${lesson.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">Delete</button>
                </div>
              </div>
            `).join('') : '<p class="text-gray-500 text-sm">No content yet</p>'}
          </div>
        </div>
      `).join('');
    }

    // Update stats
    function updateStats() {
      let videoCount = 0, docCount = 0, linkCount = 0;
      
      sections.forEach(section => {
        section.lessons?.forEach(lesson => {
          if (lesson.video_url) videoCount++;
          if (lesson.resource_urls) docCount++;
          if (!lesson.video_url && !lesson.resource_urls) linkCount++;
        });
      });

      document.getElementById('stat-sections').textContent = sections.length;
      document.getElementById('stat-videos').textContent = videoCount;
      document.getElementById('stat-docs').textContent = docCount;
      document.getElementById('stat-links').textContent = linkCount;
    }

    // Add section modal
    document.getElementById('add-section-btn').addEventListener('click', () => {
      document.getElementById('section-modal').classList.remove('hidden');
      document.getElementById('section-title-input').value = '';
    });

    document.getElementById('cancel-section-btn').addEventListener('click', () => {
      document.getElementById('section-modal').classList.add('hidden');
    });

    document.getElementById('save-section-btn').addEventListener('click', async () => {
      const title = document.getElementById('section-title-input').value.trim();
      if (!title) {
        window.Notifications.error('Please enter a section title');
        return;
      }

      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/api/course-management/${courseId}/sections`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, position: sections.length })
        });

        if (!response.ok) throw new Error('Failed to create section');

        document.getElementById('section-modal').classList.add('hidden');
        await loadSections();
      } catch (err) {
        console.error('Failed to create section:', err);
        window.Notifications.error('Failed to create section');
      }
    });

    // Open content modal
    window.openContentModal = (sectionId, sectionTitle) => {
      currentSectionId = sectionId;
      document.getElementById('modal-section-title').textContent = sectionTitle;
      document.getElementById('content-modal').classList.remove('hidden');
    };

    document.getElementById('close-content-modal-btn').addEventListener('click', () => {
      document.getElementById('content-modal').classList.add('hidden');
    });

    // Video upload
    document.getElementById('video-upload-btn').addEventListener('click', () => {
      document.getElementById('video-upload').click();
    });

    document.getElementById('video-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileType', 'video');

      const progressDiv = document.getElementById('video-upload-progress');
      const progressBar = document.getElementById('video-progress-bar');
      const progressText = document.getElementById('video-progress-text');
      
      progressDiv.classList.remove('hidden');
      progressText.textContent = 'Uploading...';

      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/api/course-management/${courseId}/upload-file`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        if (!response.ok) throw new Error('Upload failed');

        const { file: uploadedFile } = await response.json();
        
        // Create lesson with video
        await fetch(`/api/course-management/${courseId}/sections/${currentSectionId}/lessons`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            title: file.name.replace(/\.[^/.]+$/, ""),
            video_url: uploadedFile.url,
            position: 0
          })
        });

        progressText.textContent = 'Upload complete!';
        progressBar.style.width = '100%';
        
        setTimeout(() => {
          progressDiv.classList.add('hidden');
          progressBar.style.width = '0%';
          e.target.value = '';
        }, 2000);

        await loadSections();
      } catch (err) {
        console.error('Upload failed:', err);
        window.Notifications.error('Failed to upload video');
        progressDiv.classList.add('hidden');
      }
    });

    // Document upload
    document.getElementById('doc-upload-btn').addEventListener('click', () => {
      document.getElementById('doc-upload').click();
    });

    document.getElementById('doc-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileType', 'document');

      const progressDiv = document.getElementById('doc-upload-progress');
      const progressBar = document.getElementById('doc-progress-bar');
      const progressText = document.getElementById('doc-progress-text');
      
      progressDiv.classList.remove('hidden');
      progressText.textContent = 'Uploading...';

      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/api/course-management/${courseId}/upload-file`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        if (!response.ok) throw new Error('Upload failed');

        const { file: uploadedFile } = await response.json();
        
        // Create lesson with document
        await fetch(`/api/course-management/${courseId}/sections/${currentSectionId}/lessons`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            title: file.name,
            resource_urls: [uploadedFile.url],
            position: 0
          })
        });

        progressText.textContent = 'Upload complete!';
        progressBar.style.width = '100%';
        
        setTimeout(() => {
          progressDiv.classList.add('hidden');
          progressBar.style.width = '0%';
          e.target.value = '';
        }, 2000);

        await loadSections();
      } catch (err) {
        console.error('Upload failed:', err);
        window.Notifications.error('Failed to upload document');
        progressDiv.classList.add('hidden');
      }
    });

    // Add link
    document.getElementById('add-link-btn-modal').addEventListener('click', async () => {
      const title = document.getElementById('link-title-input').value.trim();
      const url = document.getElementById('link-url-input').value.trim();

      if (!title || !url) {
        window.Notifications.error('Please enter both title and URL');
        return;
      }

      try {
        const token = sessionStorage.getItem('token');
        await fetch(`/api/course-management/${courseId}/sections/${currentSectionId}/lessons`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            title: title,
            resource_urls: [url],
            position: 0
          })
        });

        document.getElementById('link-title-input').value = '';
        document.getElementById('link-url-input').value = '';
        await loadSections();
        window.Notifications.success('Link added successfully!');
      } catch (err) {
        console.error('Failed to add link:', err);
        window.Notifications.error('Failed to add link');
      }
    });

    // Delete section
    window.deleteSection = async (sectionId) => {
      const confirmed = await window.Notifications.confirm('Are you sure you want to delete this section and all its content?');
      if (!confirmed) return;

      try {
        const token = sessionStorage.getItem('token');
        await fetch(`/api/course-management/${courseId}/sections/${sectionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        await loadSections();
      } catch (err) {
        console.error('Failed to delete section:', err);
        window.Notifications.error('Failed to delete section');
      }
    };

    // Delete lesson
    window.deleteLesson = async (sectionId, lessonId) => {
      const confirmed = await window.Notifications.confirm('Are you sure you want to delete this content?');
      if (!confirmed) return;

      try {
        const token = sessionStorage.getItem('token');
        await fetch(`/api/course-management/${courseId}/sections/${sectionId}/lessons/${lessonId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        await loadSections();
      } catch (err) {
        console.error('Failed to delete lesson:', err);
        window.Notifications.error('Failed to delete content');
      }
    };

    // Delete entire course
    document.getElementById('delete-course-btn').addEventListener('click', async () => {
      const courseName = document.getElementById('course-title').textContent;
      
      // First confirmation
      const firstConfirm = await window.Notifications.confirm(`âš ï¸ WARNING: This will permanently delete the entire course "${courseName}" and all its content! This action cannot be undone. Are you sure you want to continue?`);
      if (!firstConfirm) return;

      // Double confirmation
      const finalConfirm = await window.Notifications.confirm(`Final confirmation: Delete course "${courseName}" permanently?`);
      if (!finalConfirm) return;

      const btn = document.getElementById('delete-course-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Deleting...';

      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/api/course-management/${courseId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete course');
        }

        window.Notifications.success('Course deleted successfully!');
        setTimeout(() => {
          window.location.href = '/instructorDashboard.html';
        }, 1500);
      } catch (err) {
        console.error('Failed to delete course:', err);
        window.Notifications.error('Failed to delete course: ' + err.message);
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    // View content
    window.viewContent = (lesson) => {
      const modal = document.getElementById('viewer-modal');
      const titleEl = document.getElementById('viewer-title');
      const contentEl = document.getElementById('viewer-content');
      
      titleEl.textContent = lesson.title;
      
      if (lesson.video_url) {
        // Display video
        contentEl.innerHTML = `
          <video controls class="w-full max-h-[70vh] bg-black rounded-lg">
            <source src="${lesson.video_url}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="mt-3 p-3 bg-gray-50 rounded">
            <p class="text-sm text-gray-600">Video URL:</p>
            <a href="${lesson.video_url}" target="_blank" class="text-blue-600 hover:underline text-sm break-all">${lesson.video_url}</a>
          </div>
        `;
      } else if (lesson.resource_urls && lesson.resource_urls.length > 0) {
        const url = lesson.resource_urls[0];
        const isPDF = url.toLowerCase().includes('.pdf');
        
        if (isPDF) {
          // Embed PDF
          contentEl.innerHTML = `
            <iframe src="${url}" class="w-full h-[70vh] border rounded-lg"></iframe>
            <div class="mt-3 p-3 bg-gray-50 rounded">
              <p class="text-sm text-gray-600">Document URL:</p>
              <a href="${url}" target="_blank" class="text-blue-600 hover:underline text-sm break-all">${url}</a>
              <button onclick="window.open('${url}', '_blank')" class="ml-3 px-3 py-1 bg-blue-600 text-white rounded text-sm">Open in New Tab</button>
            </div>
          `;
        } else {
          // Display link or document download
          contentEl.innerHTML = `
            <div class="p-8 text-center border-2 border-dashed rounded-lg">
              <div class="text-6xl mb-4">${url.startsWith('http') ? 'ðŸ”—' : 'ðŸ“„'}</div>
              <p class="text-lg font-semibold mb-2">${lesson.title}</p>
              <p class="text-gray-600 mb-4">Click below to open this ${url.startsWith('http') ? 'link' : 'document'}</p>
              <a href="${url}" target="_blank" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                Open ${url.startsWith('http') ? 'Link' : 'Document'}
              </a>
              <div class="mt-4 p-3 bg-gray-50 rounded">
                <p class="text-sm text-gray-600 mb-1">URL:</p>
                <p class="text-sm break-all">${url}</p>
              </div>
            </div>
          `;
        }
      } else {
        contentEl.innerHTML = '<p class="text-gray-500">No content available</p>';
      }
      
      modal.classList.remove('hidden');
    };

    // Close viewer
    document.getElementById('close-viewer-btn').addEventListener('click', () => {
      document.getElementById('viewer-modal').classList.add('hidden');
    });

    // Close viewer on background click
    document.getElementById('viewer-modal').addEventListener('click', (e) => {
      if (e.target.id === 'viewer-modal') {
        document.getElementById('viewer-modal').classList.add('hidden');
      }
    });

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadCourse);
  </script>
</body>
</html>
